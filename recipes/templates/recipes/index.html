{% load static %}
<!DOCTYPE html>
<html lang="en" style="background-color: #f1f1f1;">
<head>
  <meta charset="UTF-8">
  <title>{% if home_page %}{{ home_page.title }}{% else %}Westbrook Recipes{% endif %}</title>
  <link rel="stylesheet" href="{% static 'recipes/css/styles.css' %}">
  <style>
    /* Global Styles */
    #parent {
      width: 100%;
      height: 100%;
      overflow: hidden;
    }
    #child {
      width: 100%;
      height: 100%;
      overflow-y: scroll;
      padding-right: 17px;
      box-sizing: content-box;
    }
    body, html {
      overflow: scroll;
      -webkit-overflow-scrolling: touch;
      margin: 0;
      padding: 0;
      font-family: Arial, sans-serif;
      width: 100%;
      height: 100%;
    }
    nav {
      background: #dec773;
      padding: 17px;
    }
    nav ul {
      list-style: none;
      margin: 0;
      padding: 0;
      display: flex;
      align-items: center;
    }
    nav ul li {
      margin-right: 20px;
    }
    nav ul li a {
      color: #fff;
      text-decoration: none;
    }
    /* Right-aligned nav items */
    nav ul li.nav-right {
      margin-left: auto;
      display: flex;
      gap: 20px;
      align-items: center;
    }
    nav ul li button {
      background: none;
      border: none;
      color: #fff;
      font: inherit;
      cursor: pointer;
    }
    /* Home header styling */
    .home-header {
      height: 100vh;
      background-size: cover;
      background-position: center;
      position: relative;
      display: flex;
    }
    .overlay {
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.6);
      position: relative;
    }
    .header-content {
      position: absolute;
      top: 28vh;
      left: 11vh;
      color: #fff;
    }
    .header-content h1 {
      width: 100%;
      font-size: 3em;
      margin-bottom: 20px;
    }
    .view-recipes {
      background-color: #6495ED;
      color: #fff;
      border: none;
      padding: 10px 20px;
      font-size: 1em;
      cursor: pointer;
      margin-right: 20px;
    }
    .header-search {
      display: inline-block;
      background: #dec773;
      padding: 8px 10px;
      border-radius: 30px;
      box-shadow: 0px 4px 6px rgba(0,0,0,0.3);
      vertical-align: middle;
    }
    .header-search form {
      display: flex;
      align-items: center;
    }
    .header-search input[type="text"] {
      padding: 8px;
      border: none;
      font-size: 1em;
      border-radius: 30px 0 0 30px;
    }
    .header-search button {
      padding: 8px;
      border: none;
      font-size: 1em;
      border-radius: 0 30px 30px 0;
      cursor: pointer;
      background-color: #6495ED;
      color: #fff;
    }
    .form-container {
      width: 80%;
      margin: 20px auto;
    }
    #recipes-section {
      padding: 20px;
    }
    /* Recipe list styling */
    .recipe-list {
      list-style: none;
      padding: 0;
      margin: 20px auto;
      overflow: hidden;
    }
    .recipe-post {
      margin-bottom: 30px;
      clear: both;
    }
    .recipe-left, .recipe-right {
      width: 66.66%;
      background: #f9f9f9;
      padding: 20px;
      border-radius: 8px;
      margin-bottom: 30px;
    }
    .recipe-left {
      float: left;
    }
    .recipe-right {
      float: right;
    }
    .recipe-title {
      font-size: 1.8em;
      font-weight: bold;
      margin-bottom: 10px;
      color: #333;
      border-bottom: 2px solid #dec773;
      padding-bottom: 5px;
    }
    .recipe-instructions {
      font-size: 1em;
      line-height: 1.5;
      color: #555;
      margin-bottom: 10px;
    }
    .recipe-ingredients {
      font-size: 0.9em;
      color: #777;
    }
    /* Overlay for Turn Off Display (bouncing DVD) */
    #display-off-overlay {
      display: none;
      position: fixed;
      top: 0; left: 0;
      width: 100%; height: 100%;
      background: black;
      z-index: 1000;
      cursor: pointer;
    }
    #display-overlay-content {
      position: absolute;
      text-align: center;
      color: #fff;
      font-family: Arial, sans-serif;
    }
    #display-overlay-content .overlay-text {
      font-size: 1.5em;
      margin-bottom: 20px;
    }
    #display-overlay-content .overlay-icon img {
      width: 144px;
      height: 144px;
    }
    /* Overlay for Shutdown Device (static text) */
    #shutdown-overlay {
      display: none;
      position: fixed;
      top: 0; left: 0;
      width: 100%; height: 100%;
      background: black;
      z-index: 1000;
    }
    #shutdown-overlay .shutdown-text {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      color: white;
      font-size: 1.5em;
      font-family: Arial, sans-serif;
      text-align: center;
    }
    /* Hide scrollbar in the #child container */
    #child::-webkit-scrollbar {
      display: none;
    }
    #child {
      -ms-overflow-style: none;
      scrollbar-width: none;
    }
    /* On-Screen Keyboard Styles - Dark Gray Theme */
    .onscreen-keyboard {
      position: fixed;
      bottom: 20px;
      left: 50%;
      transform: translateX(-50%);
      background: #333;
      padding: 10px;
      border-radius: 10px;
      box-shadow: 0 4px 8px rgba(0,0,0,0.3);
      z-index: 2000;
      display: none;
      max-width: 600px;
      width: 90%;
      cursor: move;
    }
    .keyboard-row {
      display: flex;
      justify-content: center;
      margin-bottom: 5px;
    }
    .key {
      background: #555;
      border: 1px solid #777;
      border-radius: 5px;
      margin: 2px;
      padding: 10px 15px;
      font-size: 1em;
      cursor: pointer;
      outline: none;
      color: #fff;
      box-shadow: 0 2px 4px rgba(0,0,0,0.2);
    }
    .key:hover {
      background: #666;
    }
  </style>
</head>
<body>
  <div id="parent">
    <div id="child">
      <!-- Display Off Overlay (Screensaver with bouncing DVD) -->
      <div id="display-off-overlay" onclick="turnOnDisplay()">
        <div id="display-overlay-content">
          <div class="overlay-text">Touch anywhere to turn on display</div>
          <div class="overlay-icon">
            <img src="{% static '3960289.png' %}" alt="DVD Logo">
          </div>
        </div>
      </div>
      <!-- Shutdown Overlay (Static text) -->
      <div id="shutdown-overlay">
        <div class="shutdown-text">
          Please unplug and replug in your device to turn on again
        </div>
      </div>

      <!-- Navigation Bar -->
      <nav>
        <ul>
          <li><a href="{% url 'index' %}">Home</a></li>
          <li><a href="{% url 'add_recipe' %}">Add Recipe</a></li>
          <li><a href="{% url 'add_ingredient' %}">Add Ingredient</a></li>
          {% if user.is_authenticated %}
            <li><a href="{% url 'favorites' %}">My Favorites</a></li>
          {% endif %}
          <li class="nav-right">
            <a href="/admin/">Admin</a>
            <button onclick="shutdownDevice()">Shutdown Device</button>
            <button onclick="turnOffDisplay()">Turn Off Display</button>
          </li>
        </ul>
      </nav>

      <!-- Home Header Section -->
      <header class="home-header" style="background-image: url('{{ home_page.background_image.url }}');">
        <div class="overlay">
          <div class="header-content">
            <h1>{% if home_page %}{{ home_page.title }}{% else %}Westbrook Recipes{% endif %}</h1>
            <button class="view-recipes" onclick="scrollToRecipes()">View Recipes</button>
            <div class="header-search">
              <form id="search-form" method="GET" action="">
                <input type="text" id="search-input" name="q" placeholder="Search anything..." value="{{ query }}">
                <button type="submit">Search</button>
              </form>
            </div>
          </div>
        </div>
      </header>

      <!-- Recipes Section -->
      <section id="recipes-section">
        <h2>Recipes</h2>
        {% if recipes %}
          <ul class="recipe-list">
            {% for recipe in recipes %}
              <li class="recipe-post {% if forloop.counter0|divisibleby:"2" %}recipe-left{% else %}recipe-right{% endif %}">
                <div class="recipe-header">
                  <div class="recipe-title">{{ recipe.title }}</div>
                  {% if user.is_authenticated %}
                    {% if user in recipe.favorites.all %}
                      <a class="favorite-link" href="{% url 'toggle_favorite' recipe.id %}">Unfavorite</a>
                    {% else %}
                      <a class="favorite-link" href="{% url 'toggle_favorite' recipe.id %}">Favorite</a>
                    {% endif %}
                  {% endif %}
                  <div class="recipe-ingredients">
                    Ingredients:
                    {% for ingredient in recipe.ingredients.all %}
                      {{ ingredient.name }}{% if not forloop.last %}, {% endif %}
                    {% endfor %}
                  </div>
                </div>
                <div class="recipe-instructions">
                  {{ recipe.instructions|safe }}
                </div>
              </li>
            {% endfor %}
          </ul>
          <div style="clear: both;"></div>
        {% else %}
          <p>No recipes found.</p>
        {% endif %}
      </section>
    </div> <!-- end of #child -->
  </div> <!-- end of #parent -->

  <!-- On-Screen Keyboard -->
  <div id="onscreen-keyboard" class="onscreen-keyboard">
    <div class="keyboard-row">
      <button class="key">Q</button>
      <button class="key">W</button>
      <button class="key">E</button>
      <button class="key">R</button>
      <button class="key">T</button>
      <button class="key">Y</button>
      <button class="key">U</button>
      <button class="key">I</button>
      <button class="key">O</button>
      <button class="key">P</button>
    </div>
    <div class="keyboard-row">
      <button class="key">A</button>
      <button class="key">S</button>
      <button class="key">D</button>
      <button class="key">F</button>
      <button class="key">G</button>
      <button class="key">H</button>
      <button class="key">J</button>
      <button class="key">K</button>
      <button class="key">L</button>
    </div>
    <div class="keyboard-row">
      <button class="key">Z</button>
      <button class="key">X</button>
      <button class="key">C</button>
      <button class="key">V</button>
      <button class="key">B</button>
      <button class="key">N</button>
      <button class="key">M</button>
    </div>
    <div class="keyboard-row">
      <button class="key" data-key="space">Space</button>
      <button class="key" data-key="backspace">Backspace</button>
      <button class="key" data-key="hide">Hide Keyboard</button>
    </div>
  </div>

  <script>
    /* Turn Off Display (Screensaver with Bouncing DVD) */
    function turnOffDisplay() {
      var overlay = document.getElementById("display-off-overlay");
      overlay.style.display = "block";
      // Set the default message and start the bouncing animation (see below)
      document.querySelector("#display-overlay-content .overlay-text").innerText = "Touch anywhere to turn on display";
      // The bouncing animation is defined below.
    }
    function turnOnDisplay() {
      document.getElementById("display-off-overlay").style.display = "none";
    }

    /* Shutdown Device: Show static overlay, then issue shutdown after 5 seconds */
    function shutdownDevice() {
      var overlay = document.getElementById("shutdown-overlay");
      overlay.style.display = "block";
      setTimeout(function() {
        fetch('/shutdown/', { method: 'POST' })
          .then(response => console.log("Shutdown command issued"))
          .catch(error => console.error("Error issuing shutdown:", error));
      }, 5000);
    }

    /* Smooth scroll for recipes section */
    function smoothScrollContainer(container, target, duration) {
      var start = container.scrollTop;
      var change = target - start;
      var startTime = performance.now();
      function easeInOutQuad(t) {
        return t < 0.5 ? 2*t*t : -1 + (4 - 2*t)*t;
      }
      function animateScroll(currentTime) {
        var elapsed = currentTime - startTime;
        var progress = Math.min(elapsed / duration, 1);
        var easedProgress = easeInOutQuad(progress);
        container.scrollTop = start + change * easedProgress;
        if (elapsed < duration) {
          requestAnimationFrame(animateScroll);
        }
      }
      requestAnimationFrame(animateScroll);
    }
    function scrollToRecipes() {
      var recipesSection = document.getElementById("recipes-section");
      var scrollContainer = document.getElementById("child");
      if (recipesSection && scrollContainer) {
        smoothScrollContainer(scrollContainer, recipesSection.offsetTop, 800);
      }
    }
    document.addEventListener("DOMContentLoaded", function() {
      if (window.location.search.indexOf("q=") !== -1) {
        setTimeout(scrollToRecipes, 300);
      }
      // Show on-screen keyboard when search input is focused.
      var searchInput = document.getElementById("search-input");
      searchInput.addEventListener("focus", function() {
        document.getElementById("onscreen-keyboard").style.display = "block";
      });
    });

    /* On-screen keyboard functionality */
    document.querySelectorAll('#onscreen-keyboard .key').forEach(function(keyButton) {
      keyButton.addEventListener('click', function() {
        var key = this.getAttribute('data-key') || this.innerText;
        var input = document.getElementById('search-input');
        if (key.toLowerCase() === 'backspace') {
          input.value = input.value.slice(0, -1);
        } else if (key.toLowerCase() === 'space') {
          input.value += ' ';
        } else if (key.toLowerCase() === 'hide') {
          // "Hide Keyboard" no longer hides the keyboard.
        } else {
          input.value += key;
        }
        input.focus();
      });
    });

    /* Make the on-screen keyboard draggable */
    (function() {
      var keyboard = document.getElementById("onscreen-keyboard");
      var isDragging = false, startX, startY, origX, origY;
      keyboard.addEventListener("mousedown", function(e) {
        isDragging = true;
        startX = e.clientX;
        startY = e.clientY;
        origX = keyboard.offsetLeft;
        origY = keyboard.offsetTop;
        e.preventDefault();
      });
      document.addEventListener("mousemove", function(e) {
        if (isDragging) {
          var dx = e.clientX - startX;
          var dy = e.clientY - startY;
          keyboard.style.left = (origX + dx) + "px";
          keyboard.style.top = (origY + dy) + "px";
        }
      });
      document.addEventListener("mouseup", function() {
        isDragging = false;
      });
    })();

    /* Bouncing DVD Animation for Display-Off Overlay */
    (function() {
      var overlayContent = document.getElementById("display-overlay-content");
      var container = document.getElementById("display-off-overlay");
      var velocityX = (Math.random() * 0.25 + 0.5) * (Math.random() < 0.5 ? 1 : -1);
      var velocityY = (Math.random() * 0.25 + 0.5) * (Math.random() < 0.5 ? 1 : -1);
      var posX = 0, posY = 0;
      function animateOverlayContent() {
        if (container.style.display === "block") {
          var containerWidth = container.clientWidth;
          var containerHeight = container.clientHeight;
          var contentWidth = overlayContent.offsetWidth;
          var contentHeight = overlayContent.offsetHeight;
          posX += velocityX;
          posY += velocityY;
          if (posX <= 0 || posX + contentWidth >= containerWidth) {
            velocityX = -velocityX;
            posX = Math.max(0, Math.min(posX, containerWidth - contentWidth));
          }
          if (posY <= 0 || posY + contentHeight >= containerHeight) {
            velocityY = -velocityY;
            posY = Math.max(0, Math.min(posY, containerHeight - contentHeight));
          }
          overlayContent.style.left = posX + "px";
          overlayContent.style.top = posY + "px";
        }
        requestAnimationFrame(animateOverlayContent);
      }
      requestAnimationFrame(animateOverlayContent);
    })();
  </script>
</body>
</html>
